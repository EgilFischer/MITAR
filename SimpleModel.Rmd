---
title: "SimpleModelForSupernatantPaper"
author: "Egil Fischer"
date: "19-3-2020"
output:
  html_document:
    pdf_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F)
library(ggplot2)
```

## Description
The model is a very simple model of conjugation and the fraction of plasmid carrying bacteria:

$\frac{dp}{dt}= m \, \frac{\Delta\psi\, p\, (1-p)}{\psi + \Delta\psi\,  p} + \gamma \, N \, p \, (1-p)$

The following stability conditions hold for this model for the trivial ($p^* =0$) 

$\Delta \psi > -\frac{N \gamma \psi}{m + N \, \gamma}$

and the fixation ($p^* =1$) equilibrium:

$\Delta \psi < -\frac{N \gamma \psi}{m }$

The coexistence equilibrium exists and is stable if 
$-\frac{N \gamma \psi}{m } < \Delta \psi <  -\frac{N \gamma \psi}{m + N \, \gamma }$

## R functions
```{r}
stab.dpsi.trivial = function( m, psi,  N, gamma){- N*gamma*psi/(m + N * gamma)}

stab.dpsi.fixation = function(m, psi,  N, gamma){- N*gamma*psi/m}

stab.gamma.trivial = function( m, psi,  N, dpsi){- (dpsi * m) /((psi + dpsi) * N)}

stab.gamma.fixation = function(m, psi,  N, dpsi){-(dpsi * m)/(N*psi)}

```

## Plot functions
```{r}
stepsN <- 2; minN = 6; maxN =10;#log 10
#dpsi as function of gamma
stepsloggamma <-100;minloggamma = -12; maxloggamma = -7
plot.data.gammaX <- data.frame(N = rep(minN + c(0:stepsN)*(maxN-minN)/stepsN, stepsloggamma +1),
                         loggamma = rep(minloggamma+ c(0:stepsloggamma)*(maxloggamma-minloggamma)/stepsloggamma, each = stepsN + 1))

stab.triv.f <- function(loggamma, logN){stab.dpsi.trivial(m  =.1, psi = 1, N = 10^logN, gamma= 10^loggamma)}
stab.fix.f <- function(loggamma, logN){stab.dpsi.fixation(m  =.1, psi = 1, N = 10^logN, gamma= 10^loggamma)}
plot.data.gammaX$trivial <- mapply(FUN = stab.triv.f, plot.data.gammaX$loggamma,plot.data.gammaX$N)
plot.data.gammaX$fixation <- mapply(FUN = stab.fix.f, plot.data.gammaX$loggamma,plot.data.gammaX$N)

#gamma as function of dpsi
stepsdpsi <-100;mindpsi = -0.5; maxdpsi = 0.
plot.data.dpsiX <- data.frame(N = rep(minN + c(0:stepsN)*(maxN-minN)/stepsN, stepsdpsi +1),
                         dpsi = rep(mindpsi+ c(0:stepsdpsi)*(maxdpsi-mindpsi)/stepsdpsi, each = stepsN + 1))#TODO schaal gamma ook naar psi

stab.triv.logf <- function(dpsi, logN){log10(stab.gamma.trivial(m  =.1, psi = 1, N = 10^logN, dpsi= dpsi))}
stab.fix.logf <- function(dpsi, logN){log10(stab.gamma.fixation(m  =.1, psi = 1, N = 10^logN, dpsi= dpsi))}
plot.data.dpsiX$trivial <- mapply(FUN = stab.triv.logf, plot.data.dpsiX$dpsi,plot.data.dpsiX$N)
plot.data.dpsiX$fixation <- mapply(FUN = stab.fix.logf, plot.data.dpsiX$dpsi,plot.data.dpsiX$N)


```

###Single boundary plot with annotation

```{r}
ynull =-12; ymax =-8;xmin = -0.5; xmax = .25;
singleboundary.plot <- ggplot2::ggplot(data = plot.data.dpsiX[plot.data.dpsiX$N==8,])+
  geom_ribbon(aes(ymin = ynull,ymax = trivial, x = dpsi),fill = "grey", color = "black",alpha = 0.7)+
  geom_ribbon(aes(ymin = trivial,ymax = fixation, x = dpsi), fill = "black", color = "black", alpha = .7)+
  ylim(ynull,ymax)+
  xlim(xmin,xmax)+
  xlab(expression(paste("Growth rate difference: ", Delta, psi)))+
  ylab(expression(paste("log conjugation rate: ",  log[10](gamma))))+
  theme(panel.grid = element_line(colour = "DarkGray"),
        panel.background = element_rect(fill = NA), 
        axis.text = element_text(colour = NA))+
  coord_fixed(ratio = (xmax -xmin)/(ymax-ynull))
singleboundary.plot+
  geom_label(aes(x = c(0.125), y = c(-8.5)), label= c("p* = 1"))+
  geom_label(aes(x = c(-0.375), y = c(-10.5)), label= c("p* = 0"))+
  geom_label(aes(x = c(-0.25), y = c(-9.5)), label= c("0 < p* < 1"))

ggsave(paste0("C:/Surfdrive/Projecten/MITAR/ProjectShareMITAR/Papers/Microb_communities_conjugation/Figure_theoryexplained",format(Sys.Date(),"%Y%m%d"),".tiff"))

```

##Boundary plots
```{r}
ynull =-13; ymax = -7.4; xmin = -0.25; xmax = 0.25;
boundary.plots <- ggplot2::ggplot(data = plot.data.dpsiX)+
  geom_ribbon(aes(ymin = ynull,ymax = trivial, x = dpsi),fill = "grey", color = "black",alpha = 0.7)+
  geom_ribbon(aes(ymin = trivial,ymax = fixation, x = dpsi), fill = "black", color = "black", alpha = .7)+
  ylim(ynull,ymax)+
  xlim(xmin,xmax)+
  ylab("loggamma")+
  facet_grid(.~10^N)+theme_linedraw()
boundary.plots
```
## Simulation in three regions
```{r}
ode.model <- function(Time, State, Pars){
  with(as.list(c(State, Pars)),{
    dp <- m * dpsi *  p *  (1 - p)/(psi + dpsi * p) + gamma * N * p * (1-p)
    return(list(c(dp)))
  })
  
}
sim.length = 10^4
sol.trivial <- deSolve::ode(y = c(p = .5), 
                            times = c(0:sim.length),
                            func = ode.model, 
                            parms = c(dpsi =-0.25,
                                      gamma = 10^-10,
                                      psi = 1,
                                      m = 0.1,
                                      N = 10^6))
sol.fixation<- deSolve::ode(y = c(p = .5), 
                            times = c(0:sim.length),
                            func = ode.model, 
                            parms = c(dpsi =-0.25,
                                      gamma = 10^-6,
                                      psi = 1,
                                      m = 0.1,
                                      N = 10^6))

sol.coexist<- deSolve::ode(y = c(p = .5), 
                            times = c(0:sim.length),
                            func = ode.model, 
                            parms = c(dpsi =-0.25,
                                      gamma = 10^-7.5,
                                      psi = 1,
                                      m = 0.1,
                                      N = 10^6))
plot(sol.trivial,sol.fixation,sol.coexist, xlab = "Time",ylab = "Fraction with plasmid", main ="")

boundary.plots + geom_point(aes(x = dpsi, y = loggamma, color =color),
                            data = data.frame(dpsi=c(-.25,-0.25,-0.25),
                                              loggamma = c(-10,-6,-7.6),
                                              N = c(6,6,6), 
                                              color = c("trivial","fixation","coexistence") 
                                                )
                                                )
```

## Data plots load data
```{r}
#load estimated data
input.dir <- "C:/Surfdrive/Projecten/MITAR/ProjectShareMITAR/Papers/Microb_communities_conjugation/RcodeAndDataFiles/repository_R_data/"
conjugation.dataD <- read.csv(paste0(input.dir, "20200909_Conjug_rates_D_1_R.csv"))
conjugation.dataT <- read.csv(paste0(input.dir, "20200909_Conjug_rates_T_R.csv"))
growth.data <- read.csv(paste0(input.dir,"20201007_Growth_rates_D1_R_T_D2"))
#renaming to fit the existing script after renaming of columns
colnames(conjugation.dataT)[colnames(conjugation.dataT) %in% c("Genera","Treatment", "Medium")] <- c("LABgenus","VL_type", "Experiment")
colnames(conjugation.dataD)[colnames(conjugation.dataD) %in% c("Genera","Treatment", "Medium")] <- c("LABgenus","VL_type", "Experiment")
colnames(growth.data)[colnames(growth.data) %in% c( "Genera","Treatment")] <- c("LABgenus","VL_type")

#combine data 
#reshape the growth rates
data.combinations <- reshape2::dcast(growth.data,formula =LABgenus + Medium + Replicate   ~ Strain, fun.aggregate = mean )
#calculate rescaled  growth rate difference
data.combinations$dpsiDR.scaled  <- (data.combinations$D_2 -data.combinations$R)/data.combinations$R
data.combinations$dpsiTR.scaled  <- (data.combinations$T -data.combinations$R)/data.combinations$R

#order the growth rate data  and conjugation data in the same way
data.combinations<- data.combinations[order(data.combinations$Medium,data.combinations$Replicate),]
conjugation.dataD<- conjugation.dataD[order(conjugation.dataD$Experiment,conjugation.dataD$Replicate),]
conjugation.dataT<- conjugation.dataT[order(conjugation.dataT$Experiment,conjugation.dataT$Replicate),]
#add a flag to the equally named columnnames 
colnames(conjugation.dataD)<- paste0("D",colnames(conjugation.dataD))
colnames(conjugation.dataT)<- paste0("T",colnames(conjugation.dataT))
data.combinations<-cbind(data.combinations, conjugation.dataD, conjugation.dataT)

data.combinations$loggamma.scaled.D <- data.combinations$Dlog10_huisman -log10(data.combinations$R)
data.combinations$loggamma.scaled.T <- data.combinations$Tlog10_huisman-log10(data.combinations$R)


```

## Data plot with supernatant

```{r}

#create plottable data
plot.data <- reshape2::melt(data.combinations[,c("Medium","Replicate","dpsiDR.scaled","dpsiTR.scaled","loggamma.scaled.D","loggamma.scaled.T")],id.vars = c("Medium","Replicate","dpsiDR.scaled","dpsiTR.scaled"),value.name ="loggamma.scaled")
plot.data$dpsi.scaled <- plot.data$dpsiDR.scaled*(plot.data$variable == "loggamma.scaled.D")+plot.data$dpsiTR.scaled*(plot.data$variable == "loggamma.scaled.T")
plot.data$Plasmid <-gsub(pattern = "loggamma.scaled.", replacement ="", x =plot.data$variable)
new.plot.data <- NULL; for(s in c(6,8,10)) {new.plot.data <- rbind(new.plot.data,cbind(plot.data,N = s))  }
plot.data <- new.plot.data

#plot
medium.colours <- setNames(c(rep("darkblue",2), rep("orange",6)), unique(plot.data$Medium))
medium.shapes <- setNames(c(15:19,8,3,12), unique(plot.data$Medium))

boundary.plots + 
  geom_point(aes(x = dpsi.scaled, y = loggamma.scaled, shape = Medium,colour = Medium), data = plot.data[plot.data$Plasmid=="T",], size =1.75, alpha =.75)+
  scale_colour_manual(values = medium.colours, name = "Growth medium")+
  scale_shape_manual(values = medium.shapes, name = "Growth medium")+
   xlab(expression(paste("Growth rate difference: ", Delta, psi)))+
  ylab(expression(paste("log conjugation rate: ",  log[10](gamma))))+facet_grid(.~10^N)

  
ggsave(paste0("C:/Surfdrive/Projecten/MITAR/ProjectShareMITAR/Papers/Microb_communities_conjugation/Figure_estimatesandequilibrium",format(Sys.Date(),"%Y%m%d"),".tiff"))
```

## Data plots with genus-level
```{r}

#create plottable data
plot.data <- reshape2::melt(data.combinations[,c("LABgenus","Medium","Replicate","dpsiDR.scaled","dpsiTR.scaled","loggamma.scaled.D","loggamma.scaled.T")],id.vars = c("LABgenus","Medium","Replicate","dpsiDR.scaled","dpsiTR.scaled"),value.name ="loggamma.scaled")
plot.data$dpsi.scaled <- plot.data$dpsiDR.scaled*(plot.data$variable == "loggamma.scaled.D")+plot.data$dpsiTR.scaled*(plot.data$variable == "loggamma.scaled.T")
plot.data$Plasmid <-gsub(pattern = "loggamma.scaled.", replacement ="", x =plot.data$variable)
new.plot.data <- NULL; for(s in c(6,8,10)) {new.plot.data <- rbind(new.plot.data,cbind(plot.data,N = s))  }
plot.data <- new.plot.data

#plot
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73",  "#0072B2","#F0E442", "#D55E00", "#CC79A7")
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#CC79A7")
sarahPalette <- c("#000000", "darkorchid1", "chartreuse4","deepskyblue",  "#D55E00")

labgenus.colours <- setNames(sarahPalette, unique(plot.data$LABgenus))
labgenus.shapes <- setNames(c(19,8,2,6,4), unique(plot.data$LABgenus))
replicate.shapes <- setNames(c(16,17,15), unique(plot.data$Replicate))
  
boundary.plots + 
  geom_point(aes(x = dpsi.scaled, y = loggamma.scaled, shape = as.factor(LABgenus),colour = LABgenus), data = plot.data[plot.data$Plasmid=="T",], size =1.75, alpha =.75)+
  scale_colour_manual(values = labgenus.colours, name = "Medium")+
  scale_shape_manual(values = labgenus.shapes, name = "Medium")+
   xlab(expression(paste("Growth rate difference: ", Delta, psi)))+
  ylab(expression(paste("log conjugation rate: ",  log[10](gamma))))+facet_grid(.~10^N)+
theme(aspect.ratio = 1.5)

  
ggsave(paste0("C:/Surfdrive/Projecten/MITAR/ProjectShareMITAR/Papers/Microb_communities_conjugation/Figure_estimatesandequilibrium_GENUS",format(Sys.Date(),"%Y%m%d"),".tiff"))

boundary.plots + 
  geom_point(aes(x = dpsi.scaled, y = loggamma.scaled, shape = as.factor(LABgenus),colour = LABgenus), data = plot.data[plot.data$Plasmid=="T",], size =1.75, alpha =.75)+
  scale_colour_manual(values = labgenus.colours, name = "LAB genus")+
  scale_shape_manual(values = labgenus.shapes, name = "LAB genus")+
   xlab(expression(paste("Growth rate difference: ", Delta, psi)))+
  ylab(expression(paste("log conjugation rate: ",  log[10](gamma))))+facet_grid(.~10^N)+
theme(aspect.ratio = 1.5)


  
ggsave(paste0("C:/Surfdrive/Projecten/MITAR/ProjectShareMITAR/Papers/Microb_communities_conjugation/Figure_estimatesandequilibrium_GENUS_donor",format(Sys.Date(),"%Y%m%d"),".tiff"))


```

## Data plots zoomed in

```{r}

zoom.x <- c(-.15,.25)
zoom.y <- c(-13,-10)
plot.data.dpsiX$trivial[plot.data.dpsiX$trivial< min(zoom.y)] <- min(zoom.y)
plot.data.dpsiX$trivial[plot.data.dpsiX$trivial >= max(zoom.y)] <- max(zoom.y)
plot.data.dpsiX$fixation[plot.data.dpsiX$fixation< min(zoom.y)] <- min(zoom.y)
plot.data.dpsiX$fixation[plot.data.dpsiX$fixation >= max(zoom.y)] <- max(zoom.y)

ggplot2::ggplot(data = plot.data.dpsiX)+
  geom_ribbon(aes(ymin = ynull,ymax = trivial, x = dpsi),fill = "grey", color = "black",alpha = 0.7)+
  geom_ribbon(aes(ymin = trivial,ymax = fixation, x = dpsi), fill = "black", color = "black", alpha = .7)+
  ylim(ynull,ymax)+
  xlim(xmin,xmax)+
  ylab("loggamma")+
  facet_grid(.~10^N)+theme_linedraw() + 
  geom_point(aes(x = dpsi.scaled, y = loggamma.scaled, shape = Medium,colour = Medium), data = plot.data, size =1.75, alpha =.75)+
  scale_colour_manual(values = medium.colours, name = "Growth medium")+
  scale_shape_manual(values = medium.shapes, name = "Growth medium")+
  xlab(c(expression(paste(Delta, psi))))+
  ylab(expression(log10(gamma)))+
  xlim(zoom.x)+
  ylim(zoom.y)+
  facet_grid(Plasmid~10^N)

  
ggsave(paste0("C:/Surfdrive/Projecten/MITAR/ProjectShareMITAR/Papers/Microb_communities_conjugation/Figure_estimatesandequilibrium_zoomed",format(Sys.Date(),"%Y%m%d"),".tiff"))


zoom.x <- c(-.15,.25)
zoom.y <- c(-13,-10)
plot.data.dpsiX$trivial[plot.data.dpsiX$trivial< min(zoom.y)] <- min(zoom.y)
plot.data.dpsiX$trivial[plot.data.dpsiX$trivial >= max(zoom.y)] <- max(zoom.y)
plot.data.dpsiX$fixation[plot.data.dpsiX$fixation< min(zoom.y)] <- min(zoom.y)
plot.data.dpsiX$fixation[plot.data.dpsiX$fixation >= max(zoom.y)] <- max(zoom.y)

ggplot2::ggplot(data = plot.data.dpsiX[plot.data.dpsiX$N==8,])+
  geom_ribbon(aes(ymin = ynull,ymax = trivial, x = dpsi),fill = "grey", color = "black",alpha = 0.7)+
  geom_ribbon(aes(ymin = trivial,ymax = fixation, x = dpsi), fill = "black", color = "black", alpha = .7)+
  ylim(ynull,ymax)+
  xlim(xmin,xmax)+
  ylab("loggamma")+
  theme_linedraw() + 
  geom_point(aes(x = dpsi.scaled, y = loggamma.scaled, shape = Medium,colour = Medium), data = plot.data, size =1.75, alpha =.75)+
  scale_colour_manual(values = medium.colours, name = "Growth medium")+
  scale_shape_manual(values = medium.shapes, name = "Growth medium")+
  xlab(c(expression(paste(Delta, psi))))+
  ylab(expression(log10(gamma)))+
  xlim(zoom.x)+
  ylim(zoom.y)+
  facet_grid(Plasmid~.)

  
ggsave(paste0("C:/Surfdrive/Projecten/MITAR/ProjectShareMITAR/Papers/Microb_communities_conjugation/Figure_estimatesandequilibrium_zoomedN8",format(Sys.Date(),"%Y%m%d"),".tiff"))

```


